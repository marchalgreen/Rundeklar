import { readFileSync, writeFileSync, mkdirSync, existsSync } from 'node:fs'
import { dirname, resolve } from 'node:path'
import { fileURLToPath } from 'node:url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
const repoRoot = resolve(__dirname, '..')

const manifestPath = resolve(repoRoot, 'guidelines.manifest.json')
const outDir = resolve(repoRoot, 'docs')
const outFile = resolve(outDir, 'GUIDELINES_BUNDLE.md')

function main() {
  const manifest = JSON.parse(readFileSync(manifestPath, 'utf8'))
  const header = [
    '# Engineering Guidelines Bundle',
    '',
    '> Generated from guidelines.manifest.json. Do not edit this file manually.',
    '',
    'Sources (in precedence order):',
    ...manifest.precedence.map(p => `- ${p}`),
    '',
    ...(manifest.extras?.length ? ['Extras:', ...manifest.extras.map(p => `- ${p}`), ''] : [])
  ].join('\n')

  const parts = [header]
  for (const relPath of manifest.precedence) {
    const absPath = resolve(repoRoot, relPath)
    const content = readFileSync(absPath, 'utf8')
    parts.push(`\n---\n\n<!-- Source: ${relPath} -->\n\n` + content.trim() + '\n')
  }
  if (!existsSync(outDir)) mkdirSync(outDir, { recursive: true })
  writeFileSync(outFile, parts.join('\n'), 'utf8')
  // eslint-disable-next-line no-console
  console.log(`Wrote ${outFile}`)
}

main()

